
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Details on fitting &#8212; polyclonal 3.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="_static/plot_directive.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Distinct epitopes assumption" href="partition_function.html" />
    <link rel="prev" title="Sera concentrations" href="concentration_set.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Details-on-fitting">
<h1>Details on fitting<a class="headerlink" href="#Details-on-fitting" title="Permalink to this headline">¶</a></h1>
<p>Here we describe how the <code class="docutils literal notranslate"><span class="pre">polyclonal</span></code> package actually fits the models.</p>
<p>The basic idea is to minimize the difference between the predicted and measured variant-level escape probabilities, <span class="math notranslate nohighlight">\(p_v\left(c\right)\)</span>, using a loss function that is not overly sensitive to outliers. In addition, there is regularization to encourage parameters to behave under biologically motivated constraints.</p>
<section id="Implementation">
<h2>Implementation<a class="headerlink" href="#Implementation" title="Permalink to this headline">¶</a></h2>
<p>The fitting is implemented in the <code class="docutils literal notranslate"><span class="pre">Polyclonal.fit</span></code> function, which allows adjustment of the weights for the regularization. By default the optimization uses the gradient-based L-BFGS-B method implemented in <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html">scipy.optimize.minimize</a> and simply continues optimization until the minimization converges.</p>
<p>Two key details about the fitting are as follows:</p>
<ol class="arabic simple">
<li><p>By default, the fitting first fits a “site-level” model in which all mutations are lumped together so there are just two characters (wildtype and mutant). The escape values from this initial site-level fitting are then used to initialize the full mutation-level escape values which are then further optimized. The idea is that first fitting a simpler model with less parameters helps get the parameters into a “reasonable” space before full model optimization. This option is implemented via the
<code class="docutils literal notranslate"><span class="pre">fit_site_level_first</span></code> parameter to <code class="docutils literal notranslate"><span class="pre">Polyclonal.fit</span></code>, and it is recommended to use this approach as testing indicates it helps.</p></li>
<li><p>By default, if there are multiple variants with the same mutations, they are by default treated as indenpendent measurements that are fit. This can be changed to “collapse” them to a single variant that is then given a weight proportional to the number of constituent variants that is used when calculating the loss. This option is implemented by default via <code class="docutils literal notranslate"><span class="pre">collapse_identical_variants</span></code> during the initialization of a <code class="docutils literal notranslate"><span class="pre">Polyclonal</span></code> object. It speeds up fitting without (usually) substantially
changing the fitting results. However, do <strong>not</strong> collaps if you are using bootstrapping.</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">Polyclonal.fit</span></code> also allows you to adjust the weights on the regularizations. The default should be sensible, but you may want to try adjusting them about. You can also adjust the <span class="math notranslate nohighlight">\(\delta\)</span> values for the <a class="reference external" href="https://en.wikipedia.org/wiki/Huber_loss#Pseudo-Huber_loss_function">Pseudo-Huber</a> loss / regularization terms (see below), although the defaults are probably pretty good for these as they are chosen to be L1-like on most the range that values are expected to span.</p>
</section>
<section id="Loss-function">
<h2>Loss function<a class="headerlink" href="#Loss-function" title="Permalink to this headline">¶</a></h2>
<p>We use a scaled <a class="reference external" href="https://en.wikipedia.org/wiki/Huber_loss#Pseudo-Huber_loss_function">Pseudo-Huber</a> loss function on the difference between the predicted and measure escape probabilities. Note that the Pseudo-Huber function is defined as <span class="math notranslate nohighlight">\(\hat{h}_{\delta}\left(x\right) = \delta^2 \left(\sqrt{1 + \left(x/\delta\right)^2} - 1\right)\)</span> where <span class="math notranslate nohighlight">\(\delta\)</span> is a parameter that indicates when the loss transitions from being quadratic (L2-like) to linear (L1-like) in <span class="math notranslate nohighlight">\(a\)</span>. Note that we
will actually use a scaled Pseudo-Huber function of <span class="math notranslate nohighlight">\(h_{\delta}\left(x\right) = \hat{h}_{\delta}\left(x\right)/\delta\)</span> so the slope of the loss is one in the linear range. The rationale for a Pseudo-Huber loss is to be robust to outliers (L1-like for large residuals).</p>
<p>Specifically, let <span class="math notranslate nohighlight">\(r_v\left(c\right) = p_v\left(c\right) - y_{v,c}\)</span> be the residual for the predicted of the escape probability of variant <span class="math notranslate nohighlight">\(v\)</span> at concentration <span class="math notranslate nohighlight">\(c\)</span>, where we are using <span class="math notranslate nohighlight">\(y_{v,c}\)</span> to denote the measured value. Then the loss for variant <span class="math notranslate nohighlight">\(v\)</span> at concentration <span class="math notranslate nohighlight">\(c\)</span> is <span class="math notranslate nohighlight">\(L_{\delta_{\rm{loss}}}\left(r_v\left(c\right)\right) = h_{\delta_{\rm{loss}}}\left(r_v\left(c\right)\right)\)</span>, and the overall loss is:</p>
<div class="math notranslate nohighlight">
\[L = \sum_{v,c} h_{\delta_{\rm{loss}}}\left(r_v\left(c\right)\right).\]</div>
</section>
<section id="Regularization">
<h2>Regularization<a class="headerlink" href="#Regularization" title="Permalink to this headline">¶</a></h2>
<p>We also regularize the mutation escape values (<span class="math notranslate nohighlight">\(\beta_{m,e}\)</span>) and the epitope activities (<span class="math notranslate nohighlight">\(a_{\rm{wt}, e}\)</span>) based on the notions:</p>
<ol class="arabic simple">
<li><p>Most mutations should not mediate escape,</p></li>
<li><p>When a site is involved in escape for a given epitope, most mutations at a site will have similar-ish effects.</p></li>
<li><p>Epitopes should be mostly unique: a site involved in escape should usually only mediate escape from a single epitope.</p></li>
<li><p>Epitopes should be relatively spatially compact (requires structural information).</p></li>
<li><p>Epitope activities should be small (or negative) except when clear evidence to the contrary.</p></li>
</ol>
<section id="Regularization-of-escape-values">
<h3>Regularization of escape values<a class="headerlink" href="#Regularization-of-escape-values" title="Permalink to this headline">¶</a></h3>
<p>We regularize the escape values <span class="math notranslate nohighlight">\(\beta_{m,e}\)</span> using a simple Pseudo-Huber function, so that</p>
<div class="math notranslate nohighlight">
\[R_{\rm{escape}} = \lambda_{\rm{escape}} \sum_{m,e} h_{\delta_{\rm{escape}}}\left(\beta_{m,e}\right)\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda_{\rm{escape}}\)</span> is the strength of the regularization and <span class="math notranslate nohighlight">\(\delta_{\rm{escape}}\)</span> is the Psdeuo-Huber delta parameter.</p>
</section>
<section id="Regularization-of-spread-of-escape-values-at-each-site-and-epitope">
<h3>Regularization of spread of escape values at each site and epitope<a class="headerlink" href="#Regularization-of-spread-of-escape-values-at-each-site-and-epitope" title="Permalink to this headline">¶</a></h3>
<p>We regularize the variance of the escape values at each site, so that</p>
<div class="math notranslate nohighlight">
\[R_{\rm{spread}} = \lambda_{\rm{spread}} \sum_{e,i} \frac{1}{M_i}\sum_{m \in i}\left(\beta_{m,e} - \frac{1}{M_i} \sum_{m' \in i} \beta_{m',e}\right)^2\]</div>
<p>where <span class="math notranslate nohighlight">\(i\)</span> ranges over all sites, <span class="math notranslate nohighlight">\(M_i\)</span> is the number of mutations at site <span class="math notranslate nohighlight">\(i\)</span>, and <span class="math notranslate nohighlight">\(m \in i\)</span> indicates all mutations at site <span class="math notranslate nohighlight">\(i\)</span>.</p>
</section>
<section id="Regularization-of-spatial-spread-of-epitopes">
<h3>Regularization of spatial spread of epitopes<a class="headerlink" href="#Regularization-of-spatial-spread-of-epitopes" title="Permalink to this headline">¶</a></h3>
<p>To regularize the spatial spread of epitopes, we first define a differentiable measure of the average absolute value of escape at a site for an epitope <span class="math notranslate nohighlight">\(e\)</span> as</p>
<div class="math notranslate nohighlight">
\[s_{r,e} = \sqrt{\frac{1}{M_r} \sum_{m \in r} \beta_{m,e}^2 + \epsilon} - \sqrt{\epsilon}\]</div>
<p>where <span class="math notranslate nohighlight">\(\epsilon\)</span> is a small number and <span class="math notranslate nohighlight">\(m\)</span> ranges over all mutations at site <span class="math notranslate nohighlight">\(r\)</span>.</p>
<p>We then further assume that we have an experimental measure of <span class="math notranslate nohighlight">\(d_{r,r'}\)</span> of the distance between each pair of residues <span class="math notranslate nohighlight">\(r\)</span> and <span class="math notranslate nohighlight">\(r'\)</span>.</p>
<p>The regularization term is then:</p>
<div class="math notranslate nohighlight">
\[R_{\rm{spatial}} = \frac{1}{2}\sum_e \sum_r \sum_{r'} \left(\lambda_{\rm{spatial},1} d_{r,r'} + \lambda_{\rm{spatial},2} d_{r,r'}^2\right)s_{r,e} s_{r',e}\]</div>
<p>Note how this term has weights enabling regularization on both the distances and squared distances. The factor of <span class="math notranslate nohighlight">\(\frac{1}{2}\)</span> is to avoid double counting pairs, noting that the diagonal elements are always zero since the self distances are zero.</p>
</section>
<section id="Regularization-of-epitope-uniqueness">
<h3>Regularization of epitope uniqueness<a class="headerlink" href="#Regularization-of-epitope-uniqueness" title="Permalink to this headline">¶</a></h3>
<p>To regularize to ensure epitopes contain largely unique sites, we define the following term which uses the differentiable average absolute value of escape at a site for an epitope <span class="math notranslate nohighlight">\(s_{r,e}\)</span> defined above:</p>
<div class="math notranslate nohighlight">
\[R_{\rm{uniqueness}} = \frac{1}{2}\lambda_{\rm{uniqueness}} \sum_r \sum_e \sum_{e' \ne e} s_{r,e} s_{r,e'}\]</div>
<p>where <span class="math notranslate nohighlight">\(e\)</span> and <span class="math notranslate nohighlight">\(e'\)</span> range over all pairs of epitopes, and <span class="math notranslate nohighlight">\(r\)</span> ranges over all sites.</p>
</section>
<section id="Regularization-of-epitope-uniqueness^2">
<h3>Regularization of epitope uniqueness<span class="math notranslate nohighlight">\(^2\)</span><a class="headerlink" href="#Regularization-of-epitope-uniqueness^2" title="Permalink to this headline">¶</a></h3>
<p>This is a second regularization to ensure epitopes contain largely unique sites, but this one operates on the <strong>squared</strong> product of escape at a site, and so will more strongly penalize very large escape at same site, but less penalize weak shared constraint:</p>
<div class="math notranslate nohighlight">
\[R_{\rm{uniquness}^2} = \lambda_{\rm{uniqueness}^2} \sum_{i} \sum_{j &gt; i} \sum_{k} \left(\sum_{m' \in S_{k}} \beta_{m',i}^2\right)\left(\sum_{m' \in S_{k}} \beta_{m',j}^2\right)\]</div>
<p>where <span class="math notranslate nohighlight">\(i\)</span>, <span class="math notranslate nohighlight">\(j\)</span> range over all epitopes <span class="math notranslate nohighlight">\(E\)</span>, <span class="math notranslate nohighlight">\(k\)</span> is the site index, and <span class="math notranslate nohighlight">\(m' \in S_{k}\)</span> represents all mutations at site <span class="math notranslate nohighlight">\(k\)</span>.</p>
</section>
<section id="Regularization-of-epitope-activities">
<h3>Regularization of epitope activities<a class="headerlink" href="#Regularization-of-epitope-activities" title="Permalink to this headline">¶</a></h3>
<p>We regularize the epitope activities <span class="math notranslate nohighlight">\(a_{\rm{wt}, e}\)</span> to be close to zero using Pseudo-Huber function. Note that the activities are confounded with the concentration scale, so for this regularization we first compute the geometric mean concentration <span class="math notranslate nohighlight">\(c_{GM}\)</span> and incorporate that so the strength of the regularization is about the same regardless of the concentrations. Specifically, the regularization is:</p>
<div class="math notranslate nohighlight">
\[R_{\rm{activity}} = \lambda_{\rm{activity}} h_{\delta_{\rm{activity}}}\left(a_{\rm{wt}, e} + \log c_{GM} \right)\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda_{\rm{activity}}\)</span> is the strength of the regularization and <span class="math notranslate nohighlight">\(\delta_{\rm{activity}}\)</span> is the Psdeuo-Huber delta parameter.</p>
</section>
</section>
<section id="Gradients-used-for-optimization">
<h2>Gradients used for optimization<a class="headerlink" href="#Gradients-used-for-optimization" title="Permalink to this headline">¶</a></h2>
<p>Here are the formulas used to calculate the gradients in the optimization.</p>
<section id="Gradient-of-loss-function">
<h3>Gradient of loss function<a class="headerlink" href="#Gradient-of-loss-function" title="Permalink to this headline">¶</a></h3>
<p>For the loss function, the gradients are as follows:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial L}{\partial \beta_{m,e}} =
\sum_{v,c}
\frac{r_v\left(c\right)}{h_{\delta}\left(r_v\left(c\right)\right) + \delta}
p_v\left(c\right) \left[1 - U_e\left(v, c\right)\right] b\left(v\right)_m\]</div>
<div class="math notranslate nohighlight">
\[\frac{\partial L}{\partial a_{\rm{wt},e}} =
-\sum_{v,c}
\frac{r_v\left(c\right)}{h_{\delta}\left(r_v\left(c\right)\right) + \delta}
p_v\left(c\right) \left[1 - U_e\left(v, c\right)\right]\]</div>
<p>See below for how the sub-components that lead to these were calculated.</p>
<section id="Calculating-\frac{\partial-\left[h_{\delta}\left(r\right)\right]}{\partial-r}">
<h4>Calculating <span class="math notranslate nohighlight">\(\frac{\partial \left[h_{\delta}\left(r\right)\right]}{\partial r}\)</span><a class="headerlink" href="#Calculating-\frac{\partial-\left[h_{\delta}\left(r\right)\right]}{\partial-r}" title="Permalink to this headline">¶</a></h4>
<p>We have</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial \left[h_{\delta}\left(r\right)\right]}{\partial r}
= \delta \frac{\partial \left(\sqrt{1 + \left(r/\delta\right)^2} - 1\right)}{\partial r}
= \frac{\delta}{2 \sqrt{1 + \left(r/\delta\right)^2}} \frac{2r}{\delta^2}
= \frac{r}{h_{\delta}\left(r\right) + \delta}\]</div>
</section>
<section id="Calculating-\frac{\partial-p_v\left(c\right)}{\partial-\beta_{m,e}}">
<h4>Calculating <span class="math notranslate nohighlight">\(\frac{\partial p_v\left(c\right)}{\partial \beta_{m,e}}\)</span><a class="headerlink" href="#Calculating-\frac{\partial-p_v\left(c\right)}{\partial-\beta_{m,e}}" title="Permalink to this headline">¶</a></h4>
<p>First, note</p>
<div class="math notranslate nohighlight">
\[\frac{\partial p_v\left(c\right)}{\partial \beta_{m,e}} = \frac{\partial U_e\left(v, c\right)}{\partial \beta_{m,e}} \frac{p_v\left(c\right)}{U_e\left(v, c\right)}.\]</div>
<p>Next, note</p>
<div class="math notranslate nohighlight">
\[\frac{\partial U_e\left(v, c\right)}{\partial \beta_{m,e}} = \frac{\partial \phi_e\left(v\right)}{\partial \beta_{m,e}}\frac{c \exp\left(-\phi_e\left(v\right)\right) }{\left[1 + c \exp\left(-\phi_e\left(v\right)\right)\right]^2} = \frac{\partial \phi_e\left(v\right)}{\partial \beta_{m,e}} U_e\left(v, c\right) \left[1 - U_e\left(v, c\right)\right]\]</div>
<p>where the last step uses the simplification <a class="reference external" href="https://math.stackexchange.com/a/1225116">here</a>.</p>
<p>Finally, note</p>
<div class="math notranslate nohighlight">
\[\frac{\partial \phi_e\left(v\right)}{\partial \beta_{m,e}} = b\left(v\right)_m.\]</div>
<p>Putting it all together, we have:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial p_v\left(c\right)}{\partial \beta_{m,e}} = p_v\left(c\right) \left[1 - U_e\left(v, c\right)\right] b\left(v\right)_m.\]</div>
</section>
<section id="Calculating-\frac{\partial-p_v\left(c\right)}{\partial-a_{\rm{wt},e}}">
<h4>Calculating <span class="math notranslate nohighlight">\(\frac{\partial p_v\left(c\right)}{\partial a_{\rm{wt},e}}\)</span><a class="headerlink" href="#Calculating-\frac{\partial-p_v\left(c\right)}{\partial-a_{\rm{wt},e}}" title="Permalink to this headline">¶</a></h4>
<p>The only difference from above is the sign, so:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial p_v\left(c\right)}{\partial a_{\rm{wt},e}} = -p_v\left(c\right) \left[1 - U_e\left(v, c\right)\right].\]</div>
</section>
</section>
<section id="Gradients-of-regularizations">
<h3>Gradients of regularizations<a class="headerlink" href="#Gradients-of-regularizations" title="Permalink to this headline">¶</a></h3>
<section id="Calculating-\frac{\partial-R_{\rm{escape}}}{\partial-\beta_{m,e}}">
<h4>Calculating <span class="math notranslate nohighlight">\(\frac{\partial R_{\rm{escape}}}{\partial \beta_{m,e}}\)</span><a class="headerlink" href="#Calculating-\frac{\partial-R_{\rm{escape}}}{\partial-\beta_{m,e}}" title="Permalink to this headline">¶</a></h4>
<div class="math notranslate nohighlight">
\[\frac{\partial R_{\rm{escape}}}{\partial \beta_{m,e}} = \frac{\lambda_{\rm{escape}}\beta_{m,e}}{h_{\delta_{\rm{escape}}}\left(\beta_{m,e}\right) + \delta_{\rm{escape}}}\]</div>
</section>
<section id="Calculating-\frac{\partial-R_{\rm{spread}}}{\partial-\beta_{m,e}}">
<h4>Calculating <span class="math notranslate nohighlight">\(\frac{\partial R_{\rm{spread}}}{\partial \beta_{m,e}}\)</span><a class="headerlink" href="#Calculating-\frac{\partial-R_{\rm{spread}}}{\partial-\beta_{m,e}}" title="Permalink to this headline">¶</a></h4>
<div class="math notranslate nohighlight">
\[\frac{\partial R_{\rm{spread}}}{\partial \beta_{m,e}} = \frac{2\lambda_{\rm{spread}}}{M_i} \left(\beta_{m,e} - \frac{1}{M_i} \sum_{m' \in i} \beta_{m',e}\right)\]</div>
</section>
<section id="Calculating-\frac{\partial-s_{r,e}}{\partial-\beta_{m,e}}">
<h4>Calculating <span class="math notranslate nohighlight">\(\frac{\partial s_{r,e}}{\partial \beta_{m,e}}\)</span><a class="headerlink" href="#Calculating-\frac{\partial-s_{r,e}}{\partial-\beta_{m,e}}" title="Permalink to this headline">¶</a></h4>
<div class="math notranslate nohighlight">
\[\begin{split}\frac{\partial s_{r,e}}{\partial \beta_{m,e'}} =
\begin{cases}
\frac{\beta_{m,e'}}{\sqrt{M_r \sum_{m' \in r} \beta_{m',e'}^2 + \epsilon}}
&amp; \rm{if\,} m \in r \rm{\, and \,} e = e'\\
0 &amp; \rm{otherwise} \\
\end{cases}\end{split}\]</div>
</section>
<section id="Calculating-\frac{\partial-R_{\rm{spatial}}}{\partial-\beta_{m,e}}">
<h4>Calculating <span class="math notranslate nohighlight">\(\frac{\partial R_{\rm{spatial}}}{\partial \beta_{m,e}}\)</span><a class="headerlink" href="#Calculating-\frac{\partial-R_{\rm{spatial}}}{\partial-\beta_{m,e}}" title="Permalink to this headline">¶</a></h4>
<div class="math notranslate nohighlight">
\[\frac{R_{\rm{spatial}}}{\partial \beta_{m,e}}
=
\frac{1}{2}\sum_r \sum_{r'} \left(\lambda_{\rm{spatial},1} d_{r,r'} + \lambda_{\rm{spatial},2} d_{r,r'}^2\right)
\left(
\frac{s_{r,e}}{\partial \beta_{m,e}} s_{r',e} + s_{r,e} \frac{\partial s_{r',e}}{\partial \beta_{m,e}}
\right)
=
\sum_r
\left(\lambda_{\rm{spatial},1} d_{r,r_m} + \lambda_{\rm{spatial},2} d_{r,r_m}^2\right) s_{r,e} \frac{\partial s_{r_m,e}}{\partial \beta_{m,e}}\]</div>
<p>where <span class="math notranslate nohighlight">\(r_m\)</span> is the site of mutation <span class="math notranslate nohighlight">\(m\)</span>.</p>
</section>
<section id="Calculating-\frac{\partial-R_{\rm{uniqueness}}}{\partial-\beta_{m,e}}">
<h4>Calculating <span class="math notranslate nohighlight">\(\frac{\partial R_{\rm{uniqueness}}}{\partial \beta_{m,e}}\)</span><a class="headerlink" href="#Calculating-\frac{\partial-R_{\rm{uniqueness}}}{\partial-\beta_{m,e}}" title="Permalink to this headline">¶</a></h4>
<div class="math notranslate nohighlight">
\[\frac{\partial R_{\rm{uniqueness}}}{\partial \beta_{m,e}}
=
\frac{1}{2}\lambda_{\rm{uniqueness}} \sum_r \sum_{e'} \sum_{e'' \ne e'}
\left(
\frac{\partial s_{r,e'}}{\partial \beta_{m,e}} s_{r,e''} + s_{r,e'} \frac{\partial s_{r,e''}}{\partial \beta_{m,e}}
\right)
=
\lambda_{\rm{uniqueness}} \sum_{e' \ne e}
\frac{\partial s_{r_m,e}}{\partial \beta_{m,e}} s_{r_m,e'}\]</div>
</section>
<section id="Calculating-\frac{\partial-R_{\rm{uniqueness}^2}}{\partial-\beta_{m,e}}">
<h4>Calculating <span class="math notranslate nohighlight">\(\frac{\partial R_{\rm{uniqueness}^2}}{\partial \beta_{m,e}}\)</span><a class="headerlink" href="#Calculating-\frac{\partial-R_{\rm{uniqueness}^2}}{\partial-\beta_{m,e}}" title="Permalink to this headline">¶</a></h4>
<div class="math notranslate nohighlight">
\[\frac{\partial{R_{\rm{uniqueness}^2}}}{\partial{\beta_{m,e}}} = 2\lambda_{\rm{uniqueness}^2} \beta_{m,e} \sum_{j \neq e} \sum_{m' \in S_k}\left(\beta_{m',j}^2\right)\]</div>
</section>
<section id="Calculating-\frac{\partial-R_{\rm{activity}}}{\partial-a_{\rm{wt},-e}}">
<h4>Calculating <span class="math notranslate nohighlight">\(\frac{\partial R_{\rm{activity}}}{\partial a_{\rm{wt}, e}}\)</span><a class="headerlink" href="#Calculating-\frac{\partial-R_{\rm{activity}}}{\partial-a_{\rm{wt},-e}}" title="Permalink to this headline">¶</a></h4>
<div class="math notranslate nohighlight">
\[\frac{\partial R_{\rm{activity}}}{\partial a_{\rm{wt}, e}} =
\frac{\lambda_{\rm{escape}}\left(a_{\rm{wt}, e} + \log c_{GM}\right)}{h_{\delta_{\rm{activity}}}\left(a_{\rm{wt}, e} + \log c_{GM}\right) + \delta_{\rm{activity}}}\]</div>
</section>
</section>
</section>
<section id="Bootstrapping">
<h2>Bootstrapping<a class="headerlink" href="#Bootstrapping" title="Permalink to this headline">¶</a></h2>
<p>For the bootstrapping implemented by <code class="docutils literal notranslate"><span class="pre">PolyclonalBootstrap</span></code>, we start with a single pre-fit model to all the data. We then draw bootstrap replicates of the data used to fit that model, by default sampling the same variants at each concentration (see <code class="docutils literal notranslate"><span class="pre">sample_by</span></code> option of <code class="docutils literal notranslate"><span class="pre">PolyclonalBootstrap</span></code>). We then fit each of these bootstrapped models starting from the initial values from the pre-fit model on all of the data. Finally, the fit parameters or predictions from the models are summarized.
Note that mutations may not be present in some bootstrap replicates if they are only in a few variants, and this can be assessed by looking at the <code class="docutils literal notranslate"><span class="pre">frac_boostrap_replicates</span></code> column in the output from <code class="docutils literal notranslate"><span class="pre">PolyclonalBootstrap</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/BloomLogo.jpg" alt="Logo"/>
    
    <h1 class="logo logo-name">polyclonal</h1>
    
  </a>
</p>



<p class="blurb">Model mutational escape from polyclonal antibodies.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jbloomlab&repo=polyclonal&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">polyclonal documentation</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="biophysical_model.html">Biophysical model</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualize_RBD.html">Visualize antibody mix</a></li>
<li class="toctree-l1"><a class="reference internal" href="simulate_RBD.html">Simulate experiment</a></li>
<li class="toctree-l1"><a class="reference internal" href="fit_RBD.html">Fit model to data</a></li>
<li class="toctree-l1"><a class="reference internal" href="regularization.html">Regularization</a></li>
<li class="toctree-l1"><a class="reference internal" href="RBD_bootstrap.html">Bootstrapping model fits</a></li>
<li class="toctree-l1"><a class="reference internal" href="RBD_average.html">Averaging models</a></li>
<li class="toctree-l1"><a class="reference internal" href="real_LyCoV1404.html">Real antibody data example</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference_site_numbering.html">Reference site numbering</a></li>
<li class="toctree-l1"><a class="reference internal" href="real_cocktail.html">Real antibody cocktail example</a></li>
<li class="toctree-l1"><a class="reference internal" href="real_serum.html">Real serum example</a></li>
<li class="toctree-l1"><a class="reference internal" href="specify_epitopes.html">Specifying epitopes</a></li>
<li class="toctree-l1"><a class="reference internal" href="expt_design.html">Experimental design</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Details on fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="partition_function.html">Distinct epitopes assumption</a></li>
<li class="toctree-l1"><a class="reference internal" href="polyclonal.html">polyclonal package</a></li>
<li class="toctree-l1"><a class="reference internal" href="package_index.html">package index</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgments.html">Acknowledgements</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="concentration_set.html" title="previous chapter">Sera concentrations</a></li>
      <li>Next: <a href="partition_function.html" title="next chapter">Distinct epitopes assumption</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019--2023.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/optimization.nblink.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/jbloomlab/polyclonal" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>